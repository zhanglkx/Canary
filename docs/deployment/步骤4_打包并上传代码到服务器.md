# 步骤 4：打包并上传代码到服务器

时间：2025-11-16  
执行人：我  
目标：将项目代码打包并上传到服务器 /root/canary 目录

## 为什么要做这一步

1. **代码传输**：将本地开发的代码部署到服务器
2. **排除无用文件**：node_modules、dist、.next 等可以重新生成的文件
3. **减小传输大小**：只传输源代码和配置文件

## 命令/操作

### 1. 在本地打包项目（排除不必要的文件）

```bash
# 在项目根目录执行
cd /Users/zlk/Documents/Demo/nest/Canary

# 创建打包文件，排除 node_modules、dist、.next 等
tar czf canary-deploy.tar.gz \
  --exclude='node_modules' \
  --exclude='dist' \
  --exclude='.next' \
  --exclude='tsconfig.tsbuildinfo' \
  --exclude='.git' \
  --exclude='*.log' \
  --exclude='.DS_Store' \
  apps/ libs/ scripts/ docs/ \
  package.json pnpm-lock.yaml pnpm-workspace.yaml \
  tsconfig.base.json \
  docker-compose.prod.yml \
  .env.production \
  nginx.prod.conf

# 查看打包文件大小
ls -lh canary-deploy.tar.gz
```

### 2. 上传到服务器

```bash
# 使用 scp 上传
scp -i ~/.ssh/aliyun_key.pem canary-deploy.tar.gz root@8.159.144.140:/root/

# 验证上传成功（在本地执行）
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 "ls -lh /root/canary-deploy.tar.gz"
```

### 3. 在服务器上解压

```bash
# SSH 连接到服务器
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140

# 创建部署目录
mkdir -p /root/canary

# 解压文件
tar xzf /root/canary-deploy.tar.gz -C /root/canary

# 查看解压后的文件
ls -la /root/canary/

# 验证关键文件
ls -lh /root/canary/package.json
ls -lh /root/canary/.env.production
ls -lh /root/canary/nginx.prod.conf
ls -lh /root/canary/docker-compose.prod.yml

# 查看目录结构
tree -L 2 /root/canary/ 2>/dev/null || find /root/canary/ -maxdepth 2 -type d
```

## 预期结果

### 本地打包
```
canary-deploy.tar.gz    # 预计 5-20MB（不含 node_modules）
```

### 服务器文件结构
```
/root/canary/
├── apps/
│   ├── api/
│   └── web/
├── libs/
│   └── shared/
├── scripts/
├── docs/
├── package.json
├── pnpm-lock.yaml
├── pnpm-workspace.yaml
├── tsconfig.base.json
├── docker-compose.prod.yml
├── .env.production
└── nginx.prod.conf
```

### 验证标准
- ✅ 打包文件小于 50MB
- ✅ 上传成功，服务器上有 canary-deploy.tar.gz
- ✅ 解压成功，/root/canary/ 目录存在
- ✅ 关键文件齐全（package.json、.env.production、docker-compose.prod.yml）

## 实际结果

### ✅ 本地打包成功
```
canary-deploy.tar.gz    460KB（不含 node_modules）
```

### ✅ 上传成功
```
-rw-r--r-- 1 root root 461K Nov 16 10:04 /root/canary-deploy.tar.gz
```

### ✅ 服务器解压成功

**目录结构**：
```
/root/canary/
├── apps/
│   ├── api/
│   └── web/
├── libs/
│   └── shared/
├── scripts/
├── docs/
├── package.json (887 bytes)
├── pnpm-lock.yaml (450KB)
├── pnpm-workspace.yaml
├── tsconfig.base.json
├── docker-compose.prod.yml (2.6KB)
├── .env.production (750 bytes)
└── nginx.prod.conf (4.6KB)
```

**关键文件验证**：
- ✅ package.json
- ✅ .env.production
- ✅ nginx.prod.conf
- ✅ docker-compose.prod.yml
- ✅ apps/api/ 和 apps/web/ 目录

## 碰到的问题

**tar 解压警告**：大量 `Ignoring unknown extended header keyword 'LIBARCHIVE.xattr.com.apple.provenance'` 警告

## 解决方式

这些警告是 macOS 扩展属性（extended attributes），Linux tar 会自动忽略它们，不影响文件正常解压和使用。这是 macOS 和 Linux 之间的兼容性问题，可以忽略。

**如果想避免这些警告**，可以在打包时添加 `--no-xattrs` 参数：
```bash
tar czf --no-xattrs canary-deploy.tar.gz ...
```

## 下一步展望

代码已成功上传到服务器 `/root/canary/` 目录。下一步在服务器上使用 Docker Compose 构建应用的 Docker 镜像（API 和 Web）。
