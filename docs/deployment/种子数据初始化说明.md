# 种子数据初始化说明

## 问题说明

### 为什么本地有购物车数据，但服务端没有？

**原因：**
1. **服务端确实有购物车种子数据功能**，但需要手动运行命令来填充数据
2. **本地开发时**，开发者可能手动运行了 `npm run seed:carts` 命令，所以本地数据库中有数据
3. **生产环境部署时**，如果没有运行种子数据命令，数据库中就没有购物车数据

### 种子数据功能

项目提供了以下种子数据功能：

1. **产品种子数据** (`ProductSeederService`)
   - 创建示例产品、分类、SKU和库存数据
   - 包含5个完整的产品示例，每个产品都有多个SKU变体
   - 命令：`npm run seed:products`

2. **购物车种子数据** (`CartSeederService`)
   - 为现有用户创建购物车和购物车项目
   - 每个购物车包含最多10个商品
   - 命令：`npm run seed:carts`

## 解决方案

### 方法1：使用初始化脚本（推荐）

在部署完成后，运行初始化脚本：

```bash
# 填充所有种子数据（产品和购物车）
./scripts/init-seed-data.sh

# 只填充产品数据
./scripts/init-seed-data.sh --products

# 只填充购物车数据
./scripts/init-seed-data.sh --carts

# 填充指定数量的购物车
./scripts/init-seed-data.sh --carts --count=5
```

### 方法2：手动在容器中运行

```bash
# 进入 API 容器
docker exec -it canary-api-prod sh

# 在容器内执行
cd /app

# 填充产品数据
npm run seed:products

# 填充购物车数据（默认10个）
npm run seed:carts

# 或者指定数量
npm run seed:carts -- --count=10

# 退出容器
exit
```

### 方法3：在部署步骤中自动运行

在 `步骤7_初始化数据库和验证服务.md` 中已经添加了种子数据初始化步骤，按照文档执行即可。

## 种子数据命令说明

### 产品种子数据

```bash
# 填充产品数据（如果已有产品则跳过）
npm run seed:products

# 清空并重新填充
npm run seed:products -- --reseed

# 清空所有产品数据
npm run seed:products -- --clear
```

### 购物车种子数据

```bash
# 填充购物车数据（默认10个）
npm run seed:carts

# 填充指定数量的购物车
npm run seed:carts -- --count=5

# 清空并重新填充
npm run seed:carts -- --reseed

# 清空所有购物车数据
npm run seed:carts -- --clear
```

## 注意事项

1. **产品种子数据**：
   - 会自动检测是否已有产品，如果已有则跳过填充
   - 如果数据库中没有产品，购物车种子数据会失败（因为需要产品数据）

2. **购物车种子数据**：
   - 需要先有用户数据，如果没有用户会提示先创建用户
   - 需要先有产品数据，如果没有产品会提示先运行产品种子数据
   - 如果用户已有购物车，会在现有购物车中添加商品

3. **执行顺序**：
   - 先填充产品数据：`npm run seed:products`
   - 再填充购物车数据：`npm run seed:carts`

## 验证种子数据

### 检查产品数据

```bash
# 进入数据库容器
docker exec -it canary-db-prod psql -U postgres -d canary_production

# 查看产品数量
SELECT COUNT(*) FROM products;

# 查看SKU数量
SELECT COUNT(*) FROM product_skus;

# 退出
\q
```

### 检查购物车数据

```bash
# 进入数据库容器
docker exec -it canary-db-prod psql -U postgres -d canary_production

# 查看购物车数量
SELECT COUNT(*) FROM shopping_carts;

# 查看购物车项目数量
SELECT COUNT(*) FROM cart_items;

# 查看每个用户的购物车
SELECT u.email, COUNT(c.id) as cart_count, COUNT(ci.id) as item_count
FROM users u
LEFT JOIN shopping_carts c ON u.id = c.user_id
LEFT JOIN cart_items ci ON c.id = ci.cart_id
GROUP BY u.id, u.email;

# 退出
\q
```

## 相关文件

- 产品种子数据服务：`apps/api/src/common/seeders/product-seeder.service.ts`
- 产品种子数据定义：`apps/api/src/common/seeders/product-seed.ts`
- 产品种子数据命令：`apps/api/src/common/commands/seed-products.command.ts`
- 购物车种子数据服务：`apps/api/src/common/seeders/cart-seeder.service.ts`
- 购物车种子数据命令：`apps/api/src/common/commands/seed-carts.command.ts`
- 初始化脚本：`scripts/init-seed-data.sh`
