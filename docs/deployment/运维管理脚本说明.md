# 运维管理脚本说明

## 脚本位置
所有运维脚本存放在服务器的 `/root/canary/` 目录下。

## 1. 快速启停脚本

### 1.1 启动所有服务
```bash
#!/bin/bash
# start-services.sh

cd /root/canary
docker-compose -f docker-compose.prod.yml up -d

echo "等待服务启动..."
sleep 10

echo "检查服务状态..."
docker-compose -f docker-compose.prod.yml ps
```

### 1.2 停止所有服务
```bash
#!/bin/bash
# stop-services.sh

cd /root/canary
docker-compose -f docker-compose.prod.yml down

echo "所有服务已停止"
```

### 1.3 重启所有服务
```bash
#!/bin/bash
# restart-services.sh

cd /root/canary
docker-compose -f docker-compose.prod.yml restart

echo "等待服务重启..."
sleep 10

echo "检查服务状态..."
docker-compose -f docker-compose.prod.yml ps
```

## 2. 服务管理脚本

### 2.1 查看服务状态
```bash
#!/bin/bash
# check-status.sh

cd /root/canary

echo "=== 服务运行状态 ==="
docker-compose -f docker-compose.prod.yml ps

echo -e "\n=== 服务健康检查 ==="
echo "API 健康状态:"
curl -s http://localhost:4000/health | jq .

echo -e "\n=== 容器资源使用 ==="
docker stats --no-stream canary-db-prod canary-api-prod canary-web-prod canary-nginx-prod
```

### 2.2 查看服务日志
```bash
#!/bin/bash
# view-logs.sh

SERVICE=$1
LINES=${2:-100}

if [ -z "$SERVICE" ]; then
    echo "用法: $0 <service_name> [lines]"
    echo "可用服务: postgres api web nginx"
    exit 1
fi

cd /root/canary

case $SERVICE in
    postgres|db)
        docker logs --tail=$LINES canary-db-prod
        ;;
    api|backend)
        docker logs --tail=$LINES canary-api-prod
        ;;
    web|frontend)
        docker logs --tail=$LINES canary-web-prod
        ;;
    nginx|proxy)
        docker logs --tail=$LINES canary-nginx-prod
        ;;
    all)
        echo "=== PostgreSQL 日志 ==="
        docker logs --tail=$LINES canary-db-prod
        echo -e "\n=== API 日志 ==="
        docker logs --tail=$LINES canary-api-prod
        echo -e "\n=== Web 日志 ==="
        docker logs --tail=$LINES canary-web-prod
        echo -e "\n=== Nginx 日志 ==="
        docker logs --tail=$LINES canary-nginx-prod
        ;;
    *)
        echo "未知服务: $SERVICE"
        echo "可用服务: postgres api web nginx all"
        exit 1
        ;;
esac
```

## 3. 数据库管理脚本

### 3.1 数据库备份
```bash
#!/bin/bash
# backup-database.sh

BACKUP_DIR="/root/backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/canary_backup_$TIMESTAMP.sql"

# 创建备份目录
mkdir -p $BACKUP_DIR

echo "开始备份数据库..."
docker exec canary-db-prod pg_dump -U postgres canary_production > $BACKUP_FILE

if [ $? -eq 0 ]; then
    echo "备份成功: $BACKUP_FILE"
    
    # 压缩备份文件
    gzip $BACKUP_FILE
    echo "备份已压缩: ${BACKUP_FILE}.gz"
    
    # 删除 7 天前的备份
    find $BACKUP_DIR -name "canary_backup_*.sql.gz" -mtime +7 -delete
    echo "已清理 7 天前的备份"
else
    echo "备份失败"
    exit 1
fi
```

### 3.2 数据库恢复
```bash
#!/bin/bash
# restore-database.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "用法: $0 <backup_file>"
    echo "示例: $0 /root/backups/canary_backup_20250116_123456.sql.gz"
    exit 1
fi

if [ ! -f "$BACKUP_FILE" ]; then
    echo "备份文件不存在: $BACKUP_FILE"
    exit 1
fi

# 如果是压缩文件，先解压
if [[ $BACKUP_FILE == *.gz ]]; then
    echo "解压备份文件..."
    gunzip -c $BACKUP_FILE > /tmp/restore.sql
    RESTORE_FILE="/tmp/restore.sql"
else
    RESTORE_FILE=$BACKUP_FILE
fi

echo "开始恢复数据库..."
echo "⚠️  警告: 这将覆盖现有数据！"
read -p "确认继续？(yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "已取消恢复"
    exit 0
fi

# 停止 API 服务
docker-compose -f /root/canary/docker-compose.prod.yml stop api

# 恢复数据库
cat $RESTORE_FILE | docker exec -i canary-db-prod psql -U postgres canary_production

if [ $? -eq 0 ]; then
    echo "恢复成功"
    # 重启 API 服务
    docker-compose -f /root/canary/docker-compose.prod.yml start api
    echo "API 服务已重启"
else
    echo "恢复失败"
    exit 1
fi

# 清理临时文件
if [[ $BACKUP_FILE == *.gz ]]; then
    rm -f /tmp/restore.sql
fi
```

### 3.3 数据库查询
```bash
#!/bin/bash
# db-query.sh

QUERY=$1

if [ -z "$QUERY" ]; then
    echo "用法: $0 '<SQL查询>'"
    echo "示例: $0 'SELECT COUNT(*) FROM users;'"
    exit 1
fi

docker exec -it canary-db-prod psql -U postgres -d canary_production -c "$QUERY"
```

## 4. 更新部署脚本

### 4.1 更新代码
```bash
#!/bin/bash
# update-app.sh

PACKAGE_FILE=$1

if [ -z "$PACKAGE_FILE" ]; then
    echo "用法: $0 <package_file>"
    echo "示例: $0 canary-deploy.tar.gz"
    exit 1
fi

if [ ! -f "$PACKAGE_FILE" ]; then
    echo "文件不存在: $PACKAGE_FILE"
    exit 1
fi

cd /root/canary

echo "=== 备份当前配置 ==="
cp .env.production .env.production.backup.$(date +%Y%m%d_%H%M%S)

echo "=== 停止服务 ==="
docker-compose -f docker-compose.prod.yml down

echo "=== 解压新代码 ==="
tar -xzf $PACKAGE_FILE -C .

echo "=== 重新构建镜像 ==="
docker-compose -f docker-compose.prod.yml build

echo "=== 启动服务 ==="
docker-compose -f docker-compose.prod.yml up -d

echo "=== 等待服务启动 ==="
sleep 30

echo "=== 检查服务状态 ==="
docker-compose -f docker-compose.prod.yml ps

echo "=== 更新完成 ==="
```

## 5. 监控脚本

### 5.1 健康检查
```bash
#!/bin/bash
# health-check.sh

check_service() {
    local service=$1
    local url=$2
    local response=$(curl -s -o /dev/null -w "%{http_code}" $url)
    
    if [ $response -eq 200 ]; then
        echo "✅ $service: 正常"
        return 0
    else
        echo "❌ $service: 异常 (HTTP $response)"
        return 1
    fi
}

echo "=== 服务健康检查 ==="
check_service "API Health" "http://localhost:4000/health"
check_service "Web Service" "http://localhost:3000"
check_service "Nginx Proxy" "http://localhost"

echo -e "\n=== 容器状态检查 ==="
CONTAINERS=("canary-db-prod" "canary-api-prod" "canary-web-prod" "canary-nginx-prod")

for container in "${CONTAINERS[@]}"; do
    status=$(docker inspect -f '{{.State.Status}}' $container 2>/dev/null)
    if [ "$status" == "running" ]; then
        echo "✅ $container: 运行中"
    else
        echo "❌ $container: 异常 ($status)"
    fi
done

echo -e "\n=== 数据库连接检查 ==="
docker exec canary-db-prod psql -U postgres -d canary_production -c "SELECT 1;" >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ 数据库连接: 正常"
else
    echo "❌ 数据库连接: 异常"
fi
```

## 6. 清理脚本

### 6.1 清理 Docker
```bash
#!/bin/bash
# cleanup-docker.sh

echo "=== 清理 Docker 资源 ==="

echo "清理已停止的容器..."
docker container prune -f

echo "清理未使用的镜像..."
docker image prune -f

echo "清理未使用的网络..."
docker network prune -f

echo "清理未使用的卷 (不包括生产数据)..."
docker volume ls -qf dangling=true | grep -v canary_postgres_prod_data | xargs -r docker volume rm

echo "=== 清理完成 ==="
docker system df
```

## 7. 安装脚本

在服务器上创建这些脚本：

```bash
# 在服务器上执行
cd /root/canary

# 创建脚本目录
mkdir -p scripts

# 创建所有脚本并赋予执行权限
chmod +x scripts/*.sh

# 添加到 PATH（可选）
echo 'export PATH=$PATH:/root/canary/scripts' >> ~/.bashrc
source ~/.bashrc
```

## 8. 定时任务

### 8.1 设置定时备份
```bash
# 编辑 crontab
crontab -e

# 添加以下行（每天凌晨 2 点备份）
0 2 * * * /root/canary/scripts/backup-database.sh >> /var/log/canary-backup.log 2>&1

# 每小时检查一次健康状态
0 * * * * /root/canary/scripts/health-check.sh >> /var/log/canary-health.log 2>&1
```

## 9. 使用示例

```bash
# 启动服务
./scripts/start-services.sh

# 查看 API 日志
./scripts/view-logs.sh api 50

# 备份数据库
./scripts/backup-database.sh

# 健康检查
./scripts/health-check.sh

# 更新应用
./scripts/update-app.sh /path/to/new-package.tar.gz

# 清理 Docker
./scripts/cleanup-docker.sh
```

## 10. 注意事项

1. **权限管理**: 确保脚本有执行权限 (`chmod +x`)
2. **日志轮转**: 建议配置 logrotate 防止日志文件过大
3. **备份策略**: 定期测试备份恢复流程
4. **监控告警**: 配置监控工具（如 Prometheus + Grafana）
5. **安全加固**: 定期更新密码和密钥
