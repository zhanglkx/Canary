# 步骤 7：初始化数据库和验证服务

时间：2025-11-16  
执行人：我  
目标：验证数据库连接，检查表结构，测试 API 和前端访问

## 为什么要做这一步

1. **验证数据库初始化**：TypeORM 自动创建表结构
2. **测试 API 连接**：确认 GraphQL 端点可访问
3. **测试前端访问**：通过公网 IP 访问应用
4. **创建测试数据**：注册用户、创建商品、填充购物车种子数据等

## 命令/操作

### 1. 验证所有服务状态

```bash
cd /root/canary

# 查看容器状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志（确认没有错误）
docker-compose -f docker-compose.prod.yml logs --tail=50

# 查看资源使用
docker stats --no-stream
```

### 2. 检查数据库

```bash
# 进入 PostgreSQL 容器
docker exec -it canary-db-prod psql -U postgres -d canary_production

# 在 psql 中执行以下命令：
\dt              # 列出所有表
\d+ users        # 查看 users 表结构
SELECT COUNT(*) FROM users;     # 查看用户数量
\q               # 退出
```

### 3. 测试 API 端点

```bash
# 测试健康检查
curl http://localhost:4000/health

# 测试 GraphQL
curl http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ __typename }"}'

# 测试 Apollo Studio（可选，在浏览器中访问）
# http://8.159.144.140:4000/apollo-studio
```

### 4. 测试前端访问（本地）

```bash
# 测试 Nginx
curl -I http://localhost

# 测试通过 Nginx 访问 GraphQL
curl http://localhost/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ __typename }"}'

# 获取完整的 HTML
curl http://localhost | head -50
```

### 5. 测试公网访问

```bash
# 从服务器测试公网 IP
curl -I http://8.159.144.140

# 测试 API
curl http://8.159.144.140/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ __typename }"}'
```

### 6. 初始化种子数据（重要！）

**为什么需要这一步？**
- 产品种子数据：创建示例商品、分类、SKU和库存数据，方便测试和展示
- 购物车种子数据：为现有用户创建购物车和购物车项目，方便前端展示和测试

```bash
# 进入 API 容器
docker exec -it canary-api-prod sh

# 在容器内执行种子数据命令
cd /app

# 1. 填充产品数据（如果还没有产品）
npm run seed:products

# 2. 填充购物车数据（为现有用户创建购物车）
npm run seed:carts

# 或者指定数量
npm run seed:carts -- --count=10

# 退出容器
exit
```

**注意事项：**
- 产品种子数据会自动检测是否已有产品，如果已有则跳过
- 购物车种子数据会为现有用户创建购物车，如果用户已有购物车则添加商品到现有购物车
- 如果数据库中没有用户，购物车种子数据会提示先创建用户

### 7. 在本地浏览器测试

在你的本地浏览器中访问：
- **前端**: http://8.159.144.140
- **API GraphQL**: http://8.159.144.140/graphql
- **Apollo Studio**: http://8.159.144.140:4000/apollo-studio

## 预期结果

### 容器状态
```
所有容器都应该是 Up 状态：
- canary-db-prod: Up (healthy)
- canary-api-prod: Up (healthy)
- canary-web-prod: Up
- canary-nginx-prod: Up
```

### 数据库表
TypeORM 应该自动创建了表：
- users
- categories
- tags
- todos
- products
- orders
- payments
- 等等...

### API 响应
```json
{"data":{"__typename":"Query"}}
```

### 前端响应
```
HTTP/1.1 200 OK
Content-Type: text/html
```

## 实际结果

【请在执行完上述命令后，将关键输出粘贴在这里】

## 碰到的问题

【请记录遇到的任何问题】

## 解决方式

【如果有问题，请记录如何解决的】

## 下一步展望

服务验证完成后，创建标准化的运维管理脚本（启动、停止、重启、日志、备份等）。
