# é…ç½®æ–‡ä»¶æ›´æ–°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•æ›´æ–° Canary é¡¹ç›®çš„å„ç§é…ç½®æ–‡ä»¶ï¼Œä»¥åŠå“ªäº›æ›´æ”¹éœ€è¦é‡æ–°æ„å»ºé•œåƒã€‚

## ğŸ¯ å¿«é€Ÿå‚è€ƒè¡¨

| æ–‡ä»¶ç±»å‹ | éœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Ÿ | æ›´æ–°æ–¹æ³• | å½±å“èŒƒå›´ |
|---------|------------------|---------|---------|
| **nginx.prod.conf** | âŒ å¦ | ä¸Šä¼  + é‡è½½ | Nginx å®¹å™¨ |
| **.env.production** | âŒ å¦ | ä¸Šä¼  + é‡å¯æœåŠ¡ | æ‰€æœ‰æœåŠ¡ |
| **docker-compose.prod.yml** | âŒ å¦ï¼ˆé€šå¸¸ï¼‰| ä¸Šä¼  + é‡å¯ | ç›¸å…³æœåŠ¡ |
| **apps/api/** ä»£ç  | âœ… æ˜¯ | æ„å»º + é‡å¯ | API æœåŠ¡ |
| **apps/web/** ä»£ç  | âœ… æ˜¯ | æ„å»º + é‡å¯ | Web æœåŠ¡ |

## ğŸ“ è¯¦ç»†æ“ä½œæŒ‡å—

### 1. æ›´æ–° Nginx é…ç½®

#### åœºæ™¯
ä¿®æ”¹äº† `nginx.prod.conf`ï¼ˆå¦‚æ·»åŠ  CORSã€ä¿®æ”¹ä»£ç†è§„åˆ™ç­‰ï¼‰

#### æ–¹æ³• A: é›¶åœæœºæ›´æ–°ï¼ˆæ¨èï¼‰â­

```bash
# 1. åœ¨æœ¬åœ°ä¿®æ”¹ nginx.prod.conf

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i ~/.ssh/aliyun_key.pem nginx.prod.conf root@8.159.144.140:/root/canary/

# 3. SSH åˆ°æœåŠ¡å™¨
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140

# 4. è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/canary

# 5. æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®
docker exec canary-nginx-prod nginx -t

# 6. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‡æ–°åŠ è½½é…ç½®ï¼ˆé›¶åœæœºï¼‰
docker exec canary-nginx-prod nginx -s reload

# 7. éªŒè¯æœåŠ¡
./scripts/health-check.sh
```

#### æ–¹æ³• B: é‡å¯å®¹å™¨ï¼ˆç®€å•ä½†æœ‰çŸ­æš‚ä¸­æ–­ï¼‰

```bash
# 1-2. åŒä¸Š

# 3. é‡å¯ Nginx å®¹å™¨
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 '
  cd /root/canary
  docker-compose -f docker-compose.prod.yml restart nginx
'
```

#### ä½¿ç”¨ä¾¿æ·è„šæœ¬

```bash
# åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
./scripts/update-nginx-config.sh
```

#### âœ… ä¸ºä»€ä¹ˆä¸éœ€è¦é‡æ–°æ„å»ºï¼Ÿ

å› ä¸º `docker-compose.prod.yml` ä¸­ä½¿ç”¨äº† Volume æŒ‚è½½ï¼š

```yaml
nginx:
  volumes:
    - ./nginx.prod.conf:/etc/nginx/nginx.conf
```

é…ç½®æ–‡ä»¶æ˜¯ä»ä¸»æœº**å®æ—¶æŒ‚è½½**åˆ°å®¹å™¨çš„ï¼Œä¿®æ”¹ä¸»æœºä¸Šçš„æ–‡ä»¶ï¼Œå®¹å™¨å†…ä¹Ÿä¼šç«‹å³ç”Ÿæ•ˆã€‚

---

### 2. æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®

#### åœºæ™¯
ä¿®æ”¹äº† `.env.production`ï¼ˆå¦‚æ•°æ®åº“å¯†ç ã€JWT å¯†é’¥ç­‰ï¼‰

#### æ“ä½œæ­¥éª¤

```bash
# 1. åœ¨æœ¬åœ°ä¿®æ”¹ .env.production

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆâš ï¸ æ³¨æ„ï¼šåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
scp -i ~/.ssh/aliyun_key.pem .env.production root@8.159.144.140:/root/canary/

# 3. é‡å¯å—å½±å“çš„æœåŠ¡
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 '
  cd /root/canary
  
  # å¦‚æœä¿®æ”¹äº†æ•°æ®åº“é…ç½®
  docker-compose -f docker-compose.prod.yml restart postgres api
  
  # å¦‚æœä¿®æ”¹äº† API é…ç½®
  docker-compose -f docker-compose.prod.yml restart api
  
  # å¦‚æœä¿®æ”¹äº† Web é…ç½®
  docker-compose -f docker-compose.prod.yml restart web
  
  # æˆ–è€…é‡å¯æ‰€æœ‰æœåŠ¡ï¼ˆæœ€å®‰å…¨ï¼‰
  docker-compose -f docker-compose.prod.yml restart
'
```

#### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ—§é…ç½®**: 
   ```bash
   ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 \
     'cp /root/canary/.env.production /root/canary/.env.production.backup'
   ```

2. **æ•æ„Ÿä¿¡æ¯**: `.env.production` åŒ…å«å¯†ç å’Œå¯†é’¥ï¼Œç¡®ä¿å®‰å…¨ä¼ è¾“

3. **æ•°æ®åº“é…ç½®**: å¦‚æœä¿®æ”¹äº†æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œéœ€è¦ç¡®ä¿æ•°æ®åº“ä¹Ÿåšäº†ç›¸åº”ä¿®æ”¹

---

### 3. æ›´æ–° Docker Compose é…ç½®

#### åœºæ™¯
ä¿®æ”¹äº† `docker-compose.prod.yml`

#### éæ„å»ºç›¸å…³ä¿®æ”¹ï¼ˆä¸éœ€è¦é‡æ–°æ„å»ºï¼‰

ä¾‹å¦‚ï¼šç«¯å£æ˜ å°„ã€ç¯å¢ƒå˜é‡ã€é‡å¯ç­–ç•¥ç­‰

```bash
# 1. ä¸Šä¼ æ–°é…ç½®
scp -i ~/.ssh/aliyun_key.pem docker-compose.prod.yml root@8.159.144.140:/root/canary/

# 2. é‡æ–°åˆ›å»ºæœåŠ¡ï¼ˆä¼šä½¿ç”¨æ–°é…ç½®ï¼‰
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 '
  cd /root/canary
  docker-compose -f docker-compose.prod.yml up -d
'
```

#### æ„å»ºç›¸å…³ä¿®æ”¹ï¼ˆéœ€è¦é‡æ–°æ„å»ºï¼‰

ä¾‹å¦‚ï¼šä¿®æ”¹äº† Dockerfile è·¯å¾„ã€æ„å»ºå‚æ•°ç­‰

```bash
# 1. ä¸Šä¼ æ–°é…ç½®
scp -i ~/.ssh/aliyun_key.pem docker-compose.prod.yml root@8.159.144.140:/root/canary/

# 2. é‡æ–°æ„å»ºå¹¶å¯åŠ¨
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 '
  cd /root/canary
  docker-compose -f docker-compose.prod.yml build
  docker-compose -f docker-compose.prod.yml up -d
'
```

---

### 4. æ›´æ–°åº”ç”¨ä»£ç ï¼ˆéœ€è¦é‡æ–°æ„å»ºï¼‰âš ï¸

#### åœºæ™¯
ä¿®æ”¹äº† `apps/api/` æˆ– `apps/web/` ç›®å½•ä¸‹çš„ä»£ç 

#### æ“ä½œæ­¥éª¤

```bash
# 1. åœ¨æœ¬åœ°æ‰“åŒ…ä»£ç 
cd /Users/zlk/Documents/Demo/nest/Canary
tar -czf canary-deploy.tar.gz \
  apps/ \
  libs/ \
  docker-compose.prod.yml \
  nginx.prod.conf \
  package.json \
  pnpm-lock.yaml \
  pnpm-workspace.yaml \
  tsconfig.base.json

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i ~/.ssh/aliyun_key.pem canary-deploy.tar.gz root@8.159.144.140:/root/

# 3. SSH åˆ°æœåŠ¡å™¨å¹¶éƒ¨ç½²
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 '
  cd /root/canary
  
  # å¤‡ä»½é…ç½®
  cp .env.production .env.production.backup
  
  # åœæ­¢æœåŠ¡
  docker-compose -f docker-compose.prod.yml down
  
  # è§£å‹æ–°ä»£ç 
  tar -xzf /root/canary-deploy.tar.gz -C .
  
  # æ¢å¤é…ç½®
  cp .env.production.backup .env.production
  
  # é‡æ–°æ„å»ºé•œåƒ
  docker-compose -f docker-compose.prod.yml build
  
  # å¯åŠ¨æœåŠ¡
  docker-compose -f docker-compose.prod.yml up -d
  
  # ç­‰å¾…æœåŠ¡å¯åŠ¨
  sleep 20
  
  # éªŒè¯æœåŠ¡
  ./scripts/health-check.sh
'
```

#### ğŸš€ ä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

```bash
# TODO: åˆ›å»ºå®Œæ•´çš„éƒ¨ç½²è„šæœ¬
./scripts/deploy.sh
```

---

## ğŸ” å¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æ„å»ºï¼Ÿ

### âŒ ä¸éœ€è¦é‡æ–°æ„å»ºçš„æƒ…å†µ

**ç‰¹å¾**: æ–‡ä»¶æ˜¯é€šè¿‡ Volume æŒ‚è½½æˆ–ç¯å¢ƒå˜é‡æ³¨å…¥çš„

- âœ… `nginx.prod.conf` - Volume æŒ‚è½½
- âœ… `.env.production` - ç¯å¢ƒå˜é‡
- âœ… `docker-compose.prod.yml` çš„å¤§éƒ¨åˆ†é…ç½®ä¿®æ”¹
- âœ… è¿ç»´è„šæœ¬ï¼ˆ`scripts/` ç›®å½•ï¼‰

**åŸç†**: è¿™äº›æ–‡ä»¶åœ¨å®¹å™¨è¿è¡Œæ—¶ä»ä¸»æœºè¯»å–ï¼Œä¿®æ”¹ä¸»æœºæ–‡ä»¶åé‡å¯å®¹å™¨å³å¯ç”Ÿæ•ˆ

### âœ… éœ€è¦é‡æ–°æ„å»ºçš„æƒ…å†µ

**ç‰¹å¾**: æ–‡ä»¶éœ€è¦åœ¨æ„å»ºé˜¶æ®µå¤åˆ¶åˆ°é•œåƒå†…

- âš ï¸ `apps/api/src/` - TypeScript ä»£ç éœ€è¦ç¼–è¯‘
- âš ï¸ `apps/web/src/` - React/Next.js ä»£ç éœ€è¦æ„å»º
- âš ï¸ `package.json` - ä¾èµ–åŒ…éœ€è¦é‡æ–°å®‰è£…
- âš ï¸ `Dockerfile` - æ„å»ºæŒ‡ä»¤ä¿®æ”¹
- âš ï¸ `tsconfig.json` - ç¼–è¯‘é…ç½®ä¿®æ”¹

**åŸç†**: è¿™äº›æ–‡ä»¶åœ¨ `docker build` æ—¶è¢«å¤åˆ¶åˆ°é•œåƒå†…å¹¶ç¼–è¯‘/å¤„ç†ï¼Œéœ€è¦é‡æ–°æ„å»ºé•œåƒ

---

## ğŸ“Š æ›´æ–°å½±å“èŒƒå›´å¯¹æ¯”

### é…ç½®æ–‡ä»¶æ›´æ–°ï¼ˆå¿«é€Ÿï¼‰

```
ä¿®æ”¹ nginx.prod.conf
  â†“ ä¸Šä¼  (1ç§’)
  â†“ é‡è½½ Nginx (1ç§’)
  âœ… å®Œæˆï¼ˆæ€»è€—æ—¶ ~2ç§’ï¼‰
```

### ä»£ç æ›´æ–°ï¼ˆè¾ƒæ…¢ï¼‰

```
ä¿®æ”¹åº”ç”¨ä»£ç 
  â†“ æ‰“åŒ… (5ç§’)
  â†“ ä¸Šä¼  (10ç§’)
  â†“ åœæ­¢æœåŠ¡ (5ç§’)
  â†“ è§£å‹ä»£ç  (3ç§’)
  â†“ æ„å»ºé•œåƒ (3-5åˆ†é’Ÿ)
  â†“ å¯åŠ¨æœåŠ¡ (30ç§’)
  âœ… å®Œæˆï¼ˆæ€»è€—æ—¶ ~6åˆ†é’Ÿï¼‰
```

---

## ğŸ› ï¸ å¸¸è§åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1: æ·»åŠ æ–°çš„ API ç«¯ç‚¹ä»£ç†

**ä¿®æ”¹æ–‡ä»¶**: `nginx.prod.conf`

```nginx
# æ·»åŠ æ–°çš„ location å—
location /api/v2/ {
    proxy_pass http://api/v2/;
    # ...
}
```

**æ“ä½œ**:
```bash
./scripts/update-nginx-config.sh
```

**è€—æ—¶**: ~2 ç§’  
**æ˜¯å¦éœ€è¦æ„å»º**: âŒ å¦

---

### åœºæ™¯ 2: ä¿®æ”¹ JWT è¿‡æœŸæ—¶é—´

**ä¿®æ”¹æ–‡ä»¶**: `.env.production`

```bash
JWT_EXPIRATION=30d  # ä» 7d æ”¹ä¸º 30d
```

**æ“ä½œ**:
```bash
scp -i ~/.ssh/aliyun_key.pem .env.production root@8.159.144.140:/root/canary/
ssh -i ~/.ssh/aliyun_key.pem root@8.159.144.140 \
  'cd /root/canary && docker-compose -f docker-compose.prod.yml restart api'
```

**è€—æ—¶**: ~10 ç§’  
**æ˜¯å¦éœ€è¦æ„å»º**: âŒ å¦

---

### åœºæ™¯ 3: ä¿®å¤ API ä»£ç  Bug

**ä¿®æ”¹æ–‡ä»¶**: `apps/api/src/auth/auth.service.ts`

**æ“ä½œ**:
```bash
# 1. æ‰“åŒ…ä»£ç 
tar -czf canary-deploy.tar.gz apps/ libs/ ...

# 2. å®Œæ•´çš„é‡æ–°éƒ¨ç½²æµç¨‹ï¼ˆè§ä¸Šæ–‡"æ›´æ–°åº”ç”¨ä»£ç "ï¼‰
```

**è€—æ—¶**: ~6 åˆ†é’Ÿ  
**æ˜¯å¦éœ€è¦æ„å»º**: âœ… æ˜¯

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. é…ç½®æ–‡ä»¶ç®¡ç†

- âœ… å°†æ•æ„Ÿé…ç½®æ”¾åœ¨ `.env.production` ä¸­
- âœ… å°†å…¬å…±é…ç½®æ”¾åœ¨ `docker-compose.prod.yml` ä¸­
- âœ… å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
- âŒ ä¸è¦å°†æ•æ„Ÿä¿¡æ¯æäº¤åˆ° Git

### 2. æ›´æ–°ç­–ç•¥

- âœ… å°æ”¹åŠ¨ï¼ˆé…ç½®ï¼‰ï¼šç›´æ¥æ›´æ–°ï¼Œå¿«é€ŸéªŒè¯
- âœ… å¤§æ”¹åŠ¨ï¼ˆä»£ç ï¼‰ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²
- âœ… æ•°æ®åº“æ”¹åŠ¨ï¼šåŠ¡å¿…å…ˆå¤‡ä»½

### 3. å›æ»šç­–ç•¥

```bash
# ä¿ç•™æ—§é•œåƒ
docker images | grep canary

# å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå›æ»šåˆ°æ—§ç‰ˆæœ¬
docker tag canary-api-prod:old canary-api-prod:latest
docker-compose -f docker-compose.prod.yml up -d api
```

### 4. éªŒè¯æµç¨‹

æ¯æ¬¡æ›´æ–°åéƒ½åº”è¯¥ï¼š

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# 2. è¿è¡Œå¥åº·æ£€æŸ¥
./scripts/health-check.sh

# 3. æŸ¥çœ‹æ—¥å¿—
./scripts/view-logs.sh all 50

# 4. æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
curl http://8.159.144.140/api/health
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è¿ç»´ç®¡ç†è„šæœ¬è¯´æ˜](./è¿ç»´ç®¡ç†è„šæœ¬è¯´æ˜.md)
- [éƒ¨ç½²å®Œæˆæ€»ç»“](./éƒ¨ç½²å®Œæˆæ€»ç»“.md)
- [å¿«é€Ÿå‚è€ƒ](./README.md)

---

**æœ€åæ›´æ–°**: 2025-11-16  
**ç»´æŠ¤è€…**: Canary Team
