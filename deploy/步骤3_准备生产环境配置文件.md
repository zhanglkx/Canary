# 步骤 3：准备生产环境配置文件

时间：2025-11-16  
执行人：我  
目标：在本地创建生产环境配置文件（.env.production 和 nginx.prod.conf）

## 为什么要做这一步

1. **环境变量配置**：定义数据库连接、JWT 密钥等敏感信息
2. **Nginx 反向代理配置**：配置路由规则，实现前后端统一入口
3. **安全考虑**：生成强密码和密钥，避免使用默认值

## 命令/操作

### 1. 创建 .env.production 文件

在本地项目根目录创建生产环境变量文件：

**关键配置说明**：
- `DATABASE_PASSWORD`: 强密码，包含大小写字母、数字、特殊字符
- `JWT_SECRET`: 随机生成的长密钥，用于 JWT 签名
- `FRONTEND_URL`: 服务器公网 IP（暂时使用 HTTP）
- `NEXT_PUBLIC_API_URL`: API 的公网访问地址
- 支付密钥：目前使用测试占位符，后续可替换为真实密钥

### 2. 创建 nginx.prod.conf 文件

配置 Nginx 反向代理，实现：
- ✅ 前端（Next.js）：`http://8.159.144.140/`
- ✅ API（GraphQL）：`http://8.159.144.140/graphql`
- ✅ Apollo Studio：`http://8.159.144.140/apollo-studio`
- ✅ 健康检查：`http://8.159.144.140/health`

**关键特性**：
- 请求限流：API 20 req/s，Web 50 req/s
- Gzip 压缩：减少传输大小
- 静态资源缓存：1 年过期时间
- 安全头部：XSS 保护、内容类型嗅探保护
- 超时设置：GraphQL 60秒超时

### 3. 验证配置文件

```bash
# 在本地项目根目录执行
ls -lh .env.production nginx.prod.conf

# 检查文件内容
cat .env.production | grep -E "DATABASE_PASSWORD|JWT_SECRET|FRONTEND_URL"
cat nginx.prod.conf | grep -E "listen|server_name|location"
```

## 预期结果

### 文件清单
```
.env.production       # 生产环境变量（28 行）
nginx.prod.conf       # Nginx 配置（150+ 行）
```

### 配置验证
- ✅ 数据库密码足够复杂
- ✅ JWT 密钥足够长（建议 > 32 字符）
- ✅ URL 配置正确（使用服务器 IP：8.159.144.140）
- ✅ Nginx 监听 80 端口
- ✅ 路由规则完整（/, /graphql, /health, /apollo-studio）

## 实际结果

### ✅ 配置文件已创建

1. **`.env.production`**：
   - 数据库密码：强密码（52 字符）
   - JWT 密钥：强密钥（54 字符）
   - 前端 URL：http://8.159.144.140
   - API URL：http://8.159.144.140/graphql

2. **`nginx.prod.conf`**：
   - HTTP 服务监听 80 端口
   - 反向代理配置：web (3000) 和 api (4000)
   - 路由规则：/, /graphql, /apollo-studio, /health, /api/
   - 性能优化：Gzip 压缩、静态资源缓存
   - 安全配置：请求限流、安全头部

### 📝 配置说明

**为什么暂时使用 HTTP 而不是 HTTPS？**
- 初次部署，先确保服务能正常运行
- HTTPS 需要 SSL 证书（Let's Encrypt 或阿里云证书）
- 可以在服务验证成功后再配置 HTTPS（步骤 10 的一部分）

**网络架构**：
```
用户浏览器
    ↓
http://8.159.144.140 (Nginx:80)
    ↓
    ├─→ / → Next.js (web:3000)
    ├─→ /graphql → NestJS (api:4000)
    ├─→ /apollo-studio → NestJS (api:4000)
    └─→ /health → NestJS (api:4000)
```

## 碰到的问题

无

## 解决方式

无

## 下一步展望

配置文件准备完成。下一步将项目代码打包（排除 node_modules）并上传到服务器 `/root/canary` 目录。
