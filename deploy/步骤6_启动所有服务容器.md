# 步骤 6：启动所有服务容器

时间：2025-11-16  
执行人：我  
目标：使用 Docker Compose 启动所有服务（PostgreSQL、API、Web、Nginx）

## 为什么要做这一步

1. **启动数据库**：PostgreSQL 容器，存储应用数据
2. **启动后端 API**：NestJS GraphQL 服务
3. **启动前端 Web**：Next.js 应用
4. **启动反向代理**：Nginx 统一入口

## 命令/操作

### 1. 检查镜像是否就绪

```bash
cd /root/canary

# 查看已构建的镜像
docker images | grep canary

# 查看 docker-compose 配置
docker-compose -f docker-compose.prod.yml config --services
```

### 2. 启动所有服务

```bash
# 启动所有服务（后台运行）
docker-compose -f docker-compose.prod.yml up -d

# 查看启动状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志（实时）
docker-compose -f docker-compose.prod.yml logs -f

# 或者分别查看各服务日志
docker-compose -f docker-compose.prod.yml logs -f postgres
docker-compose -f docker-compose.prod.yml logs -f api
docker-compose -f docker-compose.prod.yml logs -f web
docker-compose -f docker-compose.prod.yml logs -f nginx
```

### 3. 验证服务状态

```bash
# 查看容器状态
docker ps

# 检查健康状态
docker-compose -f docker-compose.prod.yml ps

# 查看端口映射
netstat -tulpn | grep -E ':(80|3000|4000|5432)\s'

# 检查容器资源使用
docker stats --no-stream
```

### 4. 测试服务连接

```bash
# 测试 Nginx（应该返回前端页面或 502）
curl -I http://localhost

# 测试 API 健康检查
curl http://localhost:4000/health

# 测试 GraphQL（应该返回 GraphQL 响应）
curl -X POST http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ __typename }"}'
```

## 预期结果

### 容器状态
```
NAME                  STATUS                    PORTS
canary-nginx-prod     Up X minutes              0.0.0.0:80->80/tcp
canary-web-prod       Up X minutes              0.0.0.0:3000->3000/tcp
canary-api-prod       Up X minutes (healthy)    0.0.0.0:4000->4000/tcp
canary-db-prod        Up X minutes (healthy)    0.0.0.0:5432->5432/tcp
```

### 端口监听
```
80   - Nginx 反向代理
3000 - Next.js 前端
4000 - NestJS API
5432 - PostgreSQL 数据库
```

### 健康检查
- ✅ PostgreSQL: `healthy` 状态
- ✅ API: `healthy` 状态（健康检查端点响应正常）
- ✅ Web: `Up` 状态
- ✅ Nginx: `Up` 状态

## 实际结果

【请在执行完上述命令后，将关键输出粘贴在这里】

## 碰到的问题

【请记录遇到的任何问题】

### 常见问题

1. **环境变量未加载**
   - 检查 `.env.production` 文件是否存在
   - 确认文件格式正确（没有多余空格）

2. **端口冲突**
   - 使用 `netstat -tulpn | grep :端口` 检查
   - 停止占用端口的进程

3. **容器启动失败**
   - 查看日志：`docker-compose logs 服务名`
   - 检查依赖服务是否已启动

4. **数据库连接失败**
   - 等待 PostgreSQL 完全启动（需要 10-30 秒）
   - 检查数据库密码配置

## 解决方式

【如果有问题，请记录如何解决的】

## 下一步展望

服务启动成功后，验证数据库初始化是否正常，检查表结构是否创建，然后通过公网 IP 访问应用。
