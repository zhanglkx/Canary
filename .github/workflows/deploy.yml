name: Deploy to Aliyun ECS

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [closed]
    branches:
      - main
      - master

jobs:
  deploy:
    # åªåœ¨ PR åˆå¹¶åæˆ–ç›´æ¥æ¨é€åˆ° main/master æ—¶è¿è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: æ‰“åŒ…é¡¹ç›®
        run: |
          echo "å¼€å§‹æ‰“åŒ…é¡¹ç›®..."
          # ä½¿ç”¨ set +e ä¸´æ—¶å…è®¸å‘½ä»¤å¤±è´¥
          set +e
          tar czf canary-deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.next' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.log' \
            --exclude='coverage' \
            --exclude='.pnpm-store' \
            --exclude='.turbo' \
            --exclude='tmp' \
            --exclude='temp' \
            --exclude='.cache' \
            --exclude='canary-deploy.tar.gz' \
            --exclude='canary-deployment.tar.gz' \
            .
          TAR_EXIT=$?
          set -e
          
          # é€€å‡ºç  1 é€šå¸¸è¡¨ç¤ºæ–‡ä»¶åœ¨è¯»å–æ—¶è¢«ä¿®æ”¹ï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„
          # å…¶ä»–é€€å‡ºç è¡¨ç¤ºçœŸæ­£çš„é”™è¯¯
          if [ $TAR_EXIT -ne 0 ] && [ $TAR_EXIT -ne 1 ]; then
            echo "é”™è¯¯: tar å‘½ä»¤å¤±è´¥ï¼Œé€€å‡ºç : $TAR_EXIT"
            exit $TAR_EXIT
          fi
          
          # éªŒè¯æ‰“åŒ…æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f canary-deploy.tar.gz ]; then
            echo "é”™è¯¯: æ‰“åŒ…æ–‡ä»¶æœªåˆ›å»º"
            exit 1
          fi
          
          echo "âœ“ é¡¹ç›®æ‰“åŒ…å®Œæˆ"
          ls -lh canary-deploy.tar.gz
          
      - name: é…ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          # å†™å…¥ç§é’¥å¹¶ç§»é™¤å¯èƒ½çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦é—®é¢˜
          echo "${{ secrets.ALIYUN_SSH_KEY }}" | tr -d '\r' > ~/.ssh/aliyun_key.pem
          chmod 600 ~/.ssh/aliyun_key.pem
          # æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
          ssh-keyscan -H ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          # éªŒè¯å¯†é’¥æ ¼å¼
          echo "éªŒè¯ SSH å¯†é’¥..."
          ssh-keygen -l -f ~/.ssh/aliyun_key.pem || {
            echo "é”™è¯¯: SSH å¯†é’¥æ ¼å¼æ— æ•ˆ"
            exit 1
          }
          
      - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨
        run: |
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          scp -i ~/.ssh/aliyun_key.pem \
            -o StrictHostKeyChecking=no \
            canary-deploy.tar.gz \
            root@${{ secrets.ALIYUN_HOST }}:/opt/
          echo "âœ“ æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
          
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          echo "å¼€å§‹åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²..."
          ssh -i ~/.ssh/aliyun_key.pem \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            root@${{ secrets.ALIYUN_HOST }} << 'ENDSSH'
          
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p /opt/canary
          cd /opt/canary
          
          # è§£å‹æ–‡ä»¶
          echo "è§£å‹é¡¹ç›®æ–‡ä»¶..."
          tar xzf /opt/canary-deploy.tar.gz
          rm /opt/canary-deploy.tar.gz
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "åœæ­¢ç°æœ‰æœåŠ¡..."
          if [ -f docker-compose.prod.yml ]; then
            docker compose -f docker-compose.prod.yml --env-file .env.production down || true
          fi
          
          # æ¸…ç†æ—§çš„é•œåƒï¼ˆå¯é€‰ï¼ŒèŠ‚çœç©ºé—´ï¼‰
          echo "æ¸…ç†æœªä½¿ç”¨çš„ Docker èµ„æº..."
          docker system prune -f || true
          
          # åœ¨åå°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆé¿å… SSH è¶…æ—¶ï¼‰
          echo "æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰..."
          nohup docker compose -f docker-compose.prod.yml --env-file .env.production up -d --build > /tmp/docker-deploy.log 2>&1 &
          
          # è®°å½• PID
          DEPLOY_PID=$!
          echo "éƒ¨ç½²è¿›ç¨‹ PID: $DEPLOY_PID"
          
          # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æ„å»ºå¼€å§‹
          sleep 5
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if kill -0 $DEPLOY_PID 2>/dev/null; then
            echo "âœ“ éƒ¨ç½²è¿›ç¨‹æ­£åœ¨åå°è¿è¡Œ"
            echo "æ—¥å¿—æ–‡ä»¶: /tmp/docker-deploy.log"
          else
            echo "âš  éƒ¨ç½²è¿›ç¨‹å·²ç»“æŸï¼Œæ£€æŸ¥æ—¥å¿—"
            tail -20 /tmp/docker-deploy.log
          fi
          
          echo "=========================================="
          echo "âœ“ éƒ¨ç½²å·²å¯åŠ¨ï¼"
          echo "=========================================="
          echo "æ³¨æ„: Docker é•œåƒæ„å»ºåœ¨åå°è¿›è¡Œï¼Œå¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ"
          echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¿›åº¦:"
          echo "  ssh root@${{ secrets.ALIYUN_HOST }}"
          echo "  tail -f /tmp/docker-deploy.log"
          
          ENDSSH
          
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ60ç§’ï¼‰..."
          sleep 60
          
          echo "è¿æ¥æœåŠ¡å™¨æ£€æŸ¥çŠ¶æ€..."
          ssh -i ~/.ssh/aliyun_key.pem \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            root@${{ secrets.ALIYUN_HOST }} << 'ENDSSH'
          
          echo "=== å®¹å™¨çŠ¶æ€ ==="
          docker ps --filter "name=canary" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
          
          echo ""
          echo "=== éƒ¨ç½²æ—¥å¿—ï¼ˆæœ€å30è¡Œï¼‰==="
          tail -30 /tmp/docker-deploy.log || echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          
          echo ""
          echo "=== æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€ ==="
          if docker ps | grep -q "canary-api-prod.*Up"; then
            echo "âœ“ API å®¹å™¨æ­£åœ¨è¿è¡Œ"
            if curl -f http://localhost:4000/health 2>/dev/null; then
              echo "âœ“ API å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âš  API å®¹å™¨è¿è¡Œä½†å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆå¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­ï¼‰"
            fi
          else
            echo "âš  API å®¹å™¨æœªè¿è¡Œæˆ–æ­£åœ¨æ„å»ºä¸­"
          fi
          
          if docker ps | grep -q "canary-web-prod.*Up"; then
            echo "âœ“ Web å®¹å™¨æ­£åœ¨è¿è¡Œ"
          else
            echo "âš  Web å®¹å™¨æœªè¿è¡Œæˆ–æ­£åœ¨æ„å»ºä¸­"
          fi
          
          if docker ps | grep -q "canary-db-prod.*Up"; then
            echo "âœ“ æ•°æ®åº“å®¹å™¨æ­£åœ¨è¿è¡Œ"
          else
            echo "âš  æ•°æ®åº“å®¹å™¨æœªè¿è¡Œ"
          fi
          
          ENDSSH
          
          echo ""
          echo "=========================================="
          echo "æç¤º: å¦‚æœå®¹å™¨è¿˜åœ¨æ„å»ºä¸­ï¼Œè¯·ç¨åæ‰‹åŠ¨æ£€æŸ¥ï¼š"
          echo "  ssh -i ~/.ssh/aliyun_key.pem root@${{ secrets.ALIYUN_HOST }}"
          echo "  docker ps"
          echo "  tail -f /tmp/docker-deploy.log"
          echo "=========================================="
          
      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "è®¿é—®åœ°å€: http://${{ secrets.ALIYUN_HOST }}"
            echo "API åœ°å€: http://${{ secrets.ALIYUN_HOST }}/graphql"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
