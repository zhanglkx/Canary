name: Deploy to Aliyun ECS

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [closed]
    branches:
      - main
      - master

jobs:
  deploy:
    # åªåœ¨ PR åˆå¹¶åæˆ–ç›´æ¥æ¨é€åˆ° main/master æ—¶è¿è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: æ‰“åŒ…é¡¹ç›®
        run: |
          echo "å¼€å§‹æ‰“åŒ…é¡¹ç›®..."
          # ä½¿ç”¨ set +e ä¸´æ—¶å…è®¸å‘½ä»¤å¤±è´¥
          set +e
          tar czf canary-deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.next' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.log' \
            --exclude='coverage' \
            --exclude='.pnpm-store' \
            --exclude='.turbo' \
            --exclude='tmp' \
            --exclude='temp' \
            --exclude='.cache' \
            --exclude='canary-deploy.tar.gz' \
            --exclude='canary-deployment.tar.gz' \
            .
          TAR_EXIT=$?
          set -e
          
          # é€€å‡ºç  1 é€šå¸¸è¡¨ç¤ºæ–‡ä»¶åœ¨è¯»å–æ—¶è¢«ä¿®æ”¹ï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„
          # å…¶ä»–é€€å‡ºç è¡¨ç¤ºçœŸæ­£çš„é”™è¯¯
          if [ $TAR_EXIT -ne 0 ] && [ $TAR_EXIT -ne 1 ]; then
            echo "é”™è¯¯: tar å‘½ä»¤å¤±è´¥ï¼Œé€€å‡ºç : $TAR_EXIT"
            exit $TAR_EXIT
          fi
          
          # éªŒè¯æ‰“åŒ…æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f canary-deploy.tar.gz ]; then
            echo "é”™è¯¯: æ‰“åŒ…æ–‡ä»¶æœªåˆ›å»º"
            exit 1
          fi
          
          echo "âœ“ é¡¹ç›®æ‰“åŒ…å®Œæˆ"
          ls -lh canary-deploy.tar.gz
          
      - name: é…ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ALIYUN_SSH_KEY }}" > ~/.ssh/aliyun_key.pem
          chmod 600 ~/.ssh/aliyun_key.pem
          ssh-keyscan -H ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts
          
      - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨
        run: |
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          scp -i ~/.ssh/aliyun_key.pem \
            -o StrictHostKeyChecking=no \
            canary-deploy.tar.gz \
            root@${{ secrets.ALIYUN_HOST }}:/opt/
          echo "âœ“ æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
          
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          echo "å¼€å§‹åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²..."
          ssh -i ~/.ssh/aliyun_key.pem \
            -o StrictHostKeyChecking=no \
            root@${{ secrets.ALIYUN_HOST }} << 'ENDSSH'
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p /opt/canary
          cd /opt/canary
          
          # è§£å‹æ–‡ä»¶
          echo "è§£å‹é¡¹ç›®æ–‡ä»¶..."
          tar xzf /opt/canary-deploy.tar.gz
          rm /opt/canary-deploy.tar.gz
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "åœæ­¢ç°æœ‰æœåŠ¡..."
          if [ -f docker-compose.prod.yml ]; then
            docker compose -f docker-compose.prod.yml --env-file .env.production down || true
          fi
          
          # æ¸…ç†æ—§çš„é•œåƒï¼ˆå¯é€‰ï¼ŒèŠ‚çœç©ºé—´ï¼‰
          echo "æ¸…ç†æœªä½¿ç”¨çš„ Docker èµ„æº..."
          docker system prune -f || true
          
          # æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
          echo "æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
          docker compose -f docker-compose.prod.yml --env-file .env.production up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          docker ps --filter "name=canary"
          
          # æ£€æŸ¥å¥åº·çŠ¶æ€
          echo "æ£€æŸ¥ API å¥åº·çŠ¶æ€..."
          if curl -f http://localhost:4000/health; then
            echo "âœ“ API æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âš  API æœåŠ¡å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­"
          fi
          
          echo "=========================================="
          echo "âœ“ éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="
          
          ENDSSH
          
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "éªŒè¯éƒ¨ç½²..."
          sleep 5
          
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯è®¿é—®
          if curl -f http://${{ secrets.ALIYUN_HOST }}/health; then
            echo "âœ“ éƒ¨ç½²éªŒè¯æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"
          else
            echo "âš  æœåŠ¡å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç¨åæ‰‹åŠ¨æ£€æŸ¥"
          fi
          
      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "è®¿é—®åœ°å€: http://${{ secrets.ALIYUN_HOST }}"
            echo "API åœ°å€: http://${{ secrets.ALIYUN_HOST }}/graphql"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
