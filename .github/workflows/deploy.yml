name: Deploy to Aliyun

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Run tests
        run: pnpm test
        env:
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_NAME: test_db
          JWT_SECRET: test-secret

      - name: Build project
        run: pnpm build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r apps/ deployment/
          cp -r libs/ deployment/
          cp package.json pnpm-workspace.yaml pnpm-lock.yaml deployment/
          cp tsconfig.base.json deployment/
          cp docker-compose.prod.yml deployment/docker-compose.yml
          cp nginx.conf deployment/
          cp env.production.example deployment/
          tar -czf canary-deployment.tar.gz -C deployment .

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p /opt/canary
            mkdir -p /opt/backups/canary

            # å¤‡ä»½ç°æœ‰éƒ¨ç½²
            if [ -d "/opt/canary" ] && [ -n "$(ls -A /opt/canary)" ]; then
              echo "å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
              tar -czf /opt/backups/canary/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /opt/canary . || true
            fi

            # åœæ­¢ç°æœ‰æœåŠ¡
            cd /opt/canary
            docker-compose down || true

      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: 'canary-deployment.tar.gz'
          target: '/opt/canary/'

      - name: Extract and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /opt/canary

            # è§£å‹æ–°ç‰ˆæœ¬
            tar -xzf canary-deployment.tar.gz
            rm canary-deployment.tar.gz

            # å¤åˆ¶ç¯å¢ƒé…ç½®
            if [ ! -f ".env.production" ]; then
              cp env.production.example .env.production
              echo "è¯·é…ç½® .env.production æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡"
            fi

            # å¯åŠ¨æœåŠ¡
            docker-compose up -d --build

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            docker-compose ps

            # å¥åº·æ£€æŸ¥
            if curl -f http://localhost:4000/health; then
              echo "âœ… API æœåŠ¡æ­£å¸¸"
            else
              echo "âŒ API æœåŠ¡å¼‚å¸¸"
              exit 1
            fi

            if curl -f http://localhost:3000; then
              echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
            else
              echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
              exit 1
            fi

            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
