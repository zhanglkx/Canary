name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.15.0
        
    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        tar -czf deploy.tar.gz \
          --exclude=node_modules \
          --exclude=dist \
          --exclude=.next \
          --exclude=.git \
          --exclude='*.log' \
          --exclude='*.tar.gz' \
          apps/ libs/ docker-compose.prod.yml nginx.simple.conf
        echo "âœ… Package created: $(ls -lh deploy.tar.gz | awk '{print $5}')"
        
    - name: Upload deployment package
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "/tmp/"
        timeout: 10m
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60m
        command_timeout: 60m
        script_stop: true
        script: |
          set -e
          echo "ğŸš€ Starting deployment process..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /opt/canary
          echo "ğŸ“ Changed to project directory: $(pwd)"
          
          # åœæ­¢å½“å‰æœåŠ¡
          echo "ğŸ›‘ Stopping current services..."
          export $(cat .env.clean | xargs) 2>/dev/null || true
          docker-compose -f docker-compose.prod.yml down || true
          echo "âœ… Services stopped"
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          echo "ğŸ’¾ Backing up current version..."
          if [ -d "backup" ]; then
            rm -rf backup.old
            mv backup backup.old
          fi
          mkdir -p backup
          cp -r apps backup/ 2>/dev/null || true
          echo "âœ… Backup completed"
          
          # è§£å‹æ–°ç‰ˆæœ¬
          echo "ğŸ“¦ Extracting new version..."
          rm -rf apps libs docker-compose.prod.yml nginx.simple.conf
          tar -xzf /tmp/deploy.tar.gz
          rm /tmp/deploy.tar.gz
          echo "âœ… Extraction completed"
          
          # æ£€æŸ¥å¹¶å‡†å¤‡Dockerfile
          echo "ğŸ“ Preparing Dockerfiles..."
          if [ -f "apps/api/Dockerfile.local" ]; then
            mv apps/api/Dockerfile.local apps/api/Dockerfile.runtime
            echo "âœ… API Dockerfile.local renamed to Dockerfile.runtime"
          elif [ ! -f "apps/api/Dockerfile.runtime" ]; then
            echo "âŒ No API Dockerfile found"
            exit 1
          else
            echo "âœ… API Dockerfile.runtime already exists"
          fi
          
          if [ -f "apps/web/Dockerfile.local" ]; then
            mv apps/web/Dockerfile.local apps/web/Dockerfile.runtime
            echo "âœ… Web Dockerfile.local renamed to Dockerfile.runtime"
          elif [ ! -f "apps/web/Dockerfile.runtime" ]; then
            echo "âŒ No Web Dockerfile found"
            exit 1
          else
            echo "âœ… Web Dockerfile.runtime already exists"
          fi
          
          # åŠ è½½ç¯å¢ƒå˜é‡
          export $(cat .env.clean | xargs) 2>/dev/null || true
          
          # è®¾ç½® Docker æ„å»ºå‚æ•°å’Œç¼“å­˜ä¼˜åŒ–
          export DOCKER_BUILDKIT=1
          export BUILDKIT_PROGRESS=plain
          
          # æ¸…ç†æ—§çš„ Docker ç¼“å­˜ï¼ˆä¿ç•™æœ‰ç”¨çš„ç¼“å­˜ï¼‰
          echo "ğŸ§¹ Cleaning old Docker cache..."
          docker builder prune --filter until=24h -f || true
          
          # é¢„æ‹‰å–åŸºç¡€é•œåƒä»¥åˆ©ç”¨ç¼“å­˜
          echo "ğŸ“¥ Pulling base images for cache..."
          docker pull node:22.15.0-alpine || true
          
          # æ„å»ºAPIï¼ˆä½¿ç”¨ç¼“å­˜ä¼˜åŒ–ï¼‰
          echo "ğŸ”¨ Building API Docker image with cache optimization..."
          timeout 1800 docker build \
            --progress=plain \
            --network=host \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --cache-from=canary-api-prod:latest \
            --cache-from=node:22.15.0-alpine \
            -f apps/api/Dockerfile.runtime \
            -t canary-api-prod:latest . || {
            echo "âŒ API build failed or timed out"
            docker system prune -f
            exit 1
          }
          echo "âœ… API image built successfully"
          
          # æ„å»ºWebï¼ˆä½¿ç”¨ç¼“å­˜ä¼˜åŒ–ï¼‰
          echo "ğŸ”¨ Building Web Docker image with cache optimization..."
          timeout 1800 docker build \
            --progress=plain \
            --network=host \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --cache-from=canary-web-prod:latest \
            --cache-from=node:22.15.0-alpine \
            -f apps/web/Dockerfile.runtime \
            -t canary-web-prod:latest . || {
            echo "âŒ Web build failed or timed out"
            docker system prune -f
            exit 1
          }
          echo "âœ… Web image built successfully"
          
          # å¯åŠ¨æœåŠ¡
          echo "ğŸš€ Starting services..."
          docker-compose -f docker-compose.prod.yml up -d
          echo "âœ… Services started"
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ Waiting for services to be ready..."
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ğŸ” Checking service status..."
          docker-compose -f docker-compose.prod.yml ps
          
          echo "ğŸ‰ Deployment completed successfully!"
          
    - name: Cleanup on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸ§¹ Cleaning up failed deployment..."
          rm -f /tmp/deploy.tar.gz
          echo "âœ… Cleanup completed"
        
    - name: Notify deployment result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Deployment succeeded!"
        else
          echo "âŒ Deployment failed!"
        fi